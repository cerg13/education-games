<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û–±—É—á–∞—é—â–∏–µ –ò–≥—Ä—ã - –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    * {
      box-sizing: border-box;
    }

    #root {
      min-height: 100vh;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(-2deg); }
      50% { transform: translateY(-12px) rotate(2deg); }
    }

    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.4); }
      50% { box-shadow: 0 0 40px rgba(255,255,255,0.8); }
    }

    .animate-float {
      animation: float 3s ease-in-out infinite;
    }

    .animate-bounce-custom {
      animation: bounce 1s infinite;
    }

    .animate-glow {
      animation: glow 2s infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- –≠–º—É–ª—è—Ü–∏—è window.storage –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è -->
  <script>
    window.storage = {
      get: async function(key) {
        try {
          const value = localStorage.getItem(key);
          return value ? { value } : { value: null };
        } catch (e) {
          console.error('Storage get error:', e);
          return { value: null };
        }
      },
      set: async function(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (e) {
          console.error('Storage set error:', e);
        }
      },
      delete: async function(key) {
        try {
          localStorage.removeItem(key);
        } catch (e) {
          console.error('Storage delete error:', e);
        }
      }
    };
  </script>

  <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ -->
  <script type="text/babel" data-type="module">
    const { useState, useEffect, useCallback, useRef } = React;

    // ============= STORAGE UTILS =============
    const API_URL = '/api';

    async function fetchAPI(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_URL}${endpoint}`, {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers,
          },
          ...options,
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.statusText}`);
        }

        return await response.json();
      } catch (error) {
        console.error('API request failed:', error);
        throw error;
      }
    }

    const storage = {
      async getProfiles() {
        try {
          return await fetchAPI('/profiles');
        } catch (e) {
          console.error('Error loading profiles:', e);
          return [];
        }
      },

      async getCurrentProfile() {
        try {
          return await fetchAPI('/current-profile');
        } catch (e) {
          console.error('Error loading current profile:', e);
          return null;
        }
      },

      async setCurrentProfile(profileId) {
        try {
          await fetchAPI('/current-profile', {
            method: 'POST',
            body: JSON.stringify({ profileId }),
          });
        } catch (e) {
          console.error('Error setting current profile:', e);
        }
      },

      async updateProfile(profile) {
        try {
          await fetchAPI(`/profiles/${profile.id}`, {
            method: 'PUT',
            body: JSON.stringify(profile),
          });
        } catch (e) {
          console.error('Error updating profile:', e);
        }
      },

      async createProfile(name, character) {
        try {
          return await fetchAPI('/profiles', {
            method: 'POST',
            body: JSON.stringify({ name, character }),
          });
        } catch (e) {
          console.error('Error creating profile:', e);
          throw e;
        }
      },

      async deleteProfile(profileId) {
        try {
          await fetchAPI(`/profiles/${profileId}`, {
            method: 'DELETE',
          });
        } catch (e) {
          console.error('Error deleting profile:', e);
        }
      }
    };

    // ============= CONSTANTS =============
    const CHARACTERS = [
      { id: 'fox', name: '–õ–∏—Å—ë–Ω–æ–∫', emoji: 'ü¶ä', color: '#FF9F43' },
      { id: 'bunny', name: '–ó–∞–π–∫–∞', emoji: 'üê∞', color: '#A8E6CF' },
      { id: 'bear', name: '–ú–∏—à–∫–∞', emoji: 'üêª', color: '#FFEAA7' },
      { id: 'cat', name: '–ö–æ—Ç–∏–∫', emoji: 'üê±', color: '#FFB6C1' },
      { id: 'dog', name: '–©–µ–Ω–æ–∫', emoji: 'üê∂', color: '#DEB887' },
      { id: 'panda', name: '–ü–∞–Ω–¥–∞', emoji: 'üêº', color: '#E0E0E0' },
    ];

    const GAMES = [
      {
        id: 'number-racing',
        name: '–ì–æ–Ω–∫–∏ —Å –ß–∏—Å–ª–∞–º–∏',
        description: '–£—á–∏—Å—å —Å—á–∏—Ç–∞—Ç—å –∏ —Ä–µ—à–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã',
        icon: 'üèéÔ∏è',
        color: 'from-violet-600 to-purple-600',
        minAge: 4,
        skills: ['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–°—á—ë—Ç', '–õ–æ–≥–∏–∫–∞'],
      },
      {
        id: 'reading-game',
        name: '–ß–∏—Ç–∞–π–∫–∞',
        description: '–£—á–∏—Å—å —á–∏—Ç–∞—Ç—å —Å–ª–æ–≥–∏ –∏ —Å–ª–æ–≤–∞',
        icon: 'üìö',
        color: 'from-indigo-500 to-purple-600',
        minAge: 4,
        skills: ['–ß—Ç–µ–Ω–∏–µ', '–ë—É–∫–≤—ã', '–°–ª–æ–≥–∏'],
      },
      {
        id: 'number-island',
        name: '–û—Å—Ç—Ä–æ–≤ –¶–∏—Ñ—Ä',
        description: '–ò—Å—Å–ª–µ–¥—É–π –æ—Å—Ç—Ä–æ–≤ —Å –¶–∏—Ñ—Ä—è—Ç–∞–º–∏!',
        icon: 'üèùÔ∏è',
        color: 'from-amber-400 to-orange-500',
        minAge: 4,
        skills: ['–°—á—ë—Ç', '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ', '–°–ª–æ–∂–µ–Ω–∏–µ'],
      },
    ];

    // ============= HOOKS =============
    const useSpeak = () => useCallback((text, rate = 0.75) => {
      if (typeof window !== 'undefined' && window.speechSynthesis) {
        window.speechSynthesis.cancel();
        const u = new window.SpeechSynthesisUtterance(text);
        u.lang = 'ru-RU';
        u.rate = rate;
        window.speechSynthesis.speak(u);
      }
    }, []);

    // ============= COMPONENTS =============

    // Profile Select Component
    function ProfileSelect({ profiles, onSelect, onCreate, onDelete }) {
      const speak = useSpeak();

      useEffect(() => {
        speak('–í—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞');
      }, [speak]);

      return (
        <div className="min-h-screen bg-gradient-to-b from-indigo-500 to-purple-600 p-4 flex flex-col">
          <div className="text-center mb-6">
            <h1 className="text-4xl font-bold text-white mb-2">üéÆ –û–±—É—á–∞—é—â–∏–µ –ò–≥—Ä—ã</h1>
            <p className="text-white/80">–í—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞</p>
          </div>

          <div className="flex-1 overflow-auto">
            <div className="grid gap-3 mb-4">
              {profiles.map(p => {
                const char = CHARACTERS.find(c => c.id === p.character);
                return (
                  <div key={p.id} className="bg-white/20 backdrop-blur rounded-2xl p-4 flex items-center gap-4 hover:bg-white/30 transition-all">
                    <span className="text-5xl">{char?.emoji || 'üë§'}</span>
                    <div className="flex-1">
                      <p className="text-white font-bold text-xl">{p.name}</p>
                      <p className="text-white/70 text-sm">‚≠ê {p.totalStars || 0} –∑–≤—ë–∑–¥</p>
                    </div>
                    <button
                      onClick={() => onSelect(p)}
                      className="bg-gradient-to-r from-green-400 to-emerald-500 text-white px-6 py-3 rounded-xl font-bold hover:scale-105 active:scale-95 transition-all shadow-lg"
                    >
                      –ò–≥—Ä–∞—Ç—å
                    </button>
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        if (confirm(`–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞ ${p.name}?`)) {
                          onDelete(p.id);
                        }
                      }}
                      className="text-white/50 hover:text-white text-2xl transition-all"
                    >
                      ‚úï
                    </button>
                  </div>
                );
              })}
            </div>
          </div>

          <button
            onClick={onCreate}
            className="bg-gradient-to-r from-yellow-400 to-orange-400 text-gray-800 py-4 rounded-2xl font-bold text-xl hover:scale-105 active:scale-95 transition-all shadow-lg"
          >
            ‚ûï –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫
          </button>
        </div>
      );
    }

    // Create Profile Component
    function CreateProfile({ onBack, onCreate }) {
      const [step, setStep] = useState(0);
      const [character, setCharacter] = useState(null);
      const [name, setName] = useState('');
      const speak = useSpeak();

      useEffect(() => {
        speak(step === 0 ? '–í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–∞' : '–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç');
      }, [step, speak]);

      if (step === 0) {
        return (
          <div className="min-h-screen bg-gradient-to-b from-blue-400 to-purple-500 p-6 flex flex-col items-center justify-center">
            <button
              onClick={onBack}
              className="absolute top-4 left-4 text-4xl text-white hover:scale-110 transition-all"
            >
              ‚Üê
            </button>
            <p className="text-2xl text-white mb-8 font-bold">–í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–∞</p>
            <div className="grid grid-cols-3 gap-4 mb-8">
              {CHARACTERS.map(c => (
                <button
                  key={c.id}
                  onClick={() => {
                    setCharacter(c);
                    speak(c.name);
                  }}
                  className={`w-28 h-28 rounded-2xl flex flex-col items-center justify-center transition-all shadow-lg hover:scale-105 ${
                    character?.id === c.id ? 'scale-110 ring-4 ring-white' : ''
                  }`}
                  style={{ backgroundColor: c.color }}
                >
                  <span className="text-5xl mb-1">{c.emoji}</span>
                  <span className="text-sm font-bold text-gray-800">{c.name}</span>
                </button>
              ))}
            </div>
            {character && (
              <button
                onClick={() => setStep(1)}
                className="bg-white text-purple-600 text-xl font-bold py-4 px-12 rounded-full hover:scale-105 active:scale-95 transition-all shadow-lg"
              >
                –î–∞–ª—å—à–µ ‚Üí
              </button>
            )}
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-b from-blue-400 to-purple-500 p-6 flex flex-col items-center justify-center">
          <button
            onClick={() => setStep(0)}
            className="absolute top-4 left-4 text-4xl text-white hover:scale-110 transition-all"
          >
            ‚Üê
          </button>
          <span className="text-7xl mb-6">{character.emoji}</span>
          <p className="text-2xl text-white mb-6 font-bold">–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?</p>
          <input
            type="text"
            value={name}
            onChange={e => setName(e.target.value)}
            placeholder="–í–≤–µ–¥–∏ –∏–º—è"
            className="text-2xl text-center py-4 px-8 rounded-2xl bg-white/90 mb-8 w-64 outline-none shadow-lg font-bold"
            maxLength={12}
            autoFocus
          />
          {name.length > 0 && (
            <button
              onClick={() => onCreate(name, character.id)}
              className="bg-gradient-to-r from-yellow-400 to-orange-400 text-gray-800 text-xl font-bold py-4 px-12 rounded-full hover:scale-105 active:scale-95 transition-all shadow-lg"
            >
              –ü–æ–µ—Ö–∞–ª–∏! üöÄ
            </button>
          )}
        </div>
      );
    }

    // Game Menu Component
    function GameMenu({ profile, onSelectGame, onProfile, onStats }) {
      const speak = useSpeak();
      const char = CHARACTERS.find(c => c.id === profile.character);

      useEffect(() => {
        speak('–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É');
      }, [speak]);

      return (
        <div className="min-h-screen bg-gradient-to-b from-blue-400 via-purple-500 to-pink-500 p-4">
          <div className="flex items-center justify-between mb-6">
            <div
              onClick={onProfile}
              className="flex items-center gap-3 bg-white/20 backdrop-blur rounded-2xl py-2 px-4 hover:bg-white/30 transition-all cursor-pointer"
            >
              <span className="text-4xl">{char?.emoji || 'üë§'}</span>
              <div>
                <p className="text-white font-bold text-lg">{profile.name}</p>
                <p className="text-white/70 text-sm">‚≠ê {profile.totalStars || 0} –∑–≤—ë–∑–¥</p>
              </div>
            </div>

            <button
              onClick={onStats}
              className="bg-white/20 backdrop-blur p-3 rounded-xl hover:bg-white/30 transition-all"
            >
              <span className="text-3xl">üìä</span>
            </button>
          </div>

          <div className="text-center mb-8">
            <h1 className="text-5xl font-black text-white mb-2" style={{ textShadow: '2px 2px 4px rgba(0,0,0,0.3)' }}>
              üéÆ –û–±—É—á–∞—é—â–∏–µ –ò–≥—Ä—ã
            </h1>
            <p className="text-white/80 text-lg">–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É –¥–ª—è –æ–±—É—á–µ–Ω–∏—è</p>
          </div>

          <div className="space-y-4 max-w-2xl mx-auto">
            {GAMES.map((game) => (
              <button
                key={game.id}
                onClick={() => {
                  speak(game.name);
                  onSelectGame(game.id);
                }}
                className={`w-full bg-gradient-to-r ${game.color} rounded-3xl p-6 shadow-2xl hover:scale-105 active:scale-95 transition-all`}
              >
                <div className="flex items-center gap-4">
                  <span className="text-6xl">{game.icon}</span>
                  <div className="flex-1 text-left">
                    <h2 className="text-2xl font-bold text-white mb-1">{game.name}</h2>
                    <p className="text-white/80 text-sm mb-2">{game.description}</p>
                    <div className="flex gap-2 flex-wrap">
                      {game.skills.map((skill) => (
                        <span
                          key={skill}
                          className="bg-white/20 backdrop-blur px-2 py-1 rounded-lg text-xs text-white font-bold"
                        >
                          {skill}
                        </span>
                      ))}
                    </div>
                  </div>
                  <span className="text-4xl">‚ñ∂Ô∏è</span>
                </div>
              </button>
            ))}
          </div>

          <div className="mt-8 text-center">
            <p className="text-white/60 text-sm">–í—Å–µ –∏–≥—Ä—ã –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –¥–µ—Ç–µ–π –æ—Ç 4 –ª–µ—Ç</p>
          </div>
        </div>
      );
    }

    // Stats Screen Component
    function StatsScreen({ profile, onBack }) {
      const speak = useSpeak();

      useEffect(() => {
        speak('–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞');
      }, [speak]);

      const stats = profile.stats || {};
      const days = Object.entries(stats).sort((a, b) => b[0].localeCompare(a[0])).slice(0, 7);

      const totalGames = days.reduce((sum, [_, data]) => sum + (data.gamesPlayed || 0), 0);
      const totalTasks = days.reduce((sum, [_, data]) => sum + (data.tasksCompleted || 0), 0);

      return (
        <div className="min-h-screen bg-gradient-to-b from-violet-500 to-purple-600 p-4">
          <div className="flex items-center mb-6">
            <button
              onClick={onBack}
              className="text-4xl text-white hover:scale-110 transition-all mr-4"
            >
              ‚Üê
            </button>
            <h2 className="text-3xl font-bold text-white">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
          </div>

          <div className="grid grid-cols-2 gap-3 mb-6">
            <div className="bg-white/20 backdrop-blur rounded-2xl p-4 text-center">
              <span className="text-4xl block mb-2">‚≠ê</span>
              <p className="text-3xl font-black text-white">{profile.totalStars || 0}</p>
              <p className="text-white/70 text-sm">–í—Å–µ–≥–æ –∑–≤—ë–∑–¥</p>
            </div>
            <div className="bg-white/20 backdrop-blur rounded-2xl p-4 text-center">
              <span className="text-4xl block mb-2">üéÆ</span>
              <p className="text-3xl font-black text-white">{totalGames}</p>
              <p className="text-white/70 text-sm">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</p>
            </div>
          </div>

          <h3 className="text-white font-bold mb-3">–ò—Å—Ç–æ—Ä–∏—è –æ–±—É—á–µ–Ω–∏—è</h3>
          {days.length === 0 ? (
            <div className="text-center text-white/60 mt-12">
              <p className="text-5xl mb-4">üìö</p>
              <p>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞—á–Ω–∏ –∏–≥—Ä–∞—Ç—å!</p>
            </div>
          ) : (
            <div className="space-y-3">
              {days.map(([date, data]) => (
                <div key={date} className="bg-white/20 backdrop-blur rounded-xl p-4">
                  <p className="text-white/80 text-sm mb-2">
                    {new Date(date).toLocaleDateString('ru-RU', {
                      weekday: 'long',
                      day: 'numeric',
                      month: 'short',
                    })}
                  </p>
                  <div className="flex justify-between text-white">
                    <span>üìã {data.tasksCompleted || 0} –∑–∞–¥–∞–Ω–∏–π</span>
                    <span>‚≠ê +{data.starsEarned || 0}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // Main Marketplace Component
    function Marketplace() {
      const [screen, setScreen] = useState('loading');
      const [profiles, setProfiles] = useState([]);
      const [currentProfile, setCurrentProfile] = useState(null);
      const [selectedGame, setSelectedGame] = useState(null);

      useEffect(() => {
        const loadProfiles = async () => {
          const loadedProfiles = await storage.getProfiles();
          setProfiles(loadedProfiles);

          const currentProfileId = await storage.getCurrentProfile();
          if (currentProfileId && loadedProfiles.length > 0) {
            const profile = loadedProfiles.find(p => p.id === currentProfileId.id);
            if (profile) {
              setCurrentProfile(profile);
              setScreen('menu');
              return;
            }
          }

          setScreen('profiles');
        };

        loadProfiles();
      }, []);

      const handleSelectProfile = async (profile) => {
        setCurrentProfile(profile);
        await storage.setCurrentProfile(profile.id);
        setScreen('menu');
      };

      const handleCreateProfile = async (name, character) => {
        const newProfile = await storage.createProfile(name, character);
        setProfiles([...profiles, newProfile]);
        setCurrentProfile(newProfile);
        await storage.setCurrentProfile(newProfile.id);
        setScreen('menu');
      };

      const handleDeleteProfile = async (id) => {
        await storage.deleteProfile(id);
        const updatedProfiles = profiles.filter(p => p.id !== id);
        setProfiles(updatedProfiles);

        if (currentProfile?.id === id) {
          setCurrentProfile(null);
          setScreen('profiles');
        }
      };

      const handleSelectGame = (gameId) => {
        setSelectedGame(gameId);

        // –ü–µ—Ä–µ–¥–∞—ë–º ID –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä
        const profileId = currentProfile?.id || '';
        if (gameId === 'number-racing') {
          window.location.href = `games-number-racing.html?profile=${profileId}`;
        } else if (gameId === 'reading-game') {
          window.location.href = `games-reading.html?profile=${profileId}`;
        } else if (gameId === 'number-island') {
          window.location.href = `games-number-island.html?profile=${profileId}`;
        }
      };

      const handleBackFromGame = async () => {
        const updatedProfiles = await storage.getProfiles();
        const updatedProfile = updatedProfiles.find(p => p.id === currentProfile?.id);
        if (updatedProfile) {
          setCurrentProfile(updatedProfile);
        }
        setProfiles(updatedProfiles);
        setSelectedGame(null);
        setScreen('menu');
      };

      if (screen === 'loading') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-indigo-600 to-purple-700 flex items-center justify-center">
            <div className="text-center">
              <div className="text-7xl mb-4 animate-bounce">üéÆ</div>
              <p className="text-white text-2xl">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
          </div>
        );
      }

      if (screen === 'profiles') {
        return (
          <ProfileSelect
            profiles={profiles}
            onSelect={handleSelectProfile}
            onCreate={() => setScreen('create')}
            onDelete={handleDeleteProfile}
          />
        );
      }

      if (screen === 'create') {
        return (
          <CreateProfile
            onBack={() => setScreen('profiles')}
            onCreate={handleCreateProfile}
          />
        );
      }

      if (screen === 'stats' && currentProfile) {
        return (
          <StatsScreen
            profile={currentProfile}
            onBack={() => setScreen('menu')}
          />
        );
      }

      if (screen === 'menu' && currentProfile) {
        return (
          <GameMenu
            profile={currentProfile}
            onSelectGame={handleSelectGame}
            onProfile={() => setScreen('profiles')}
            onStats={() => setScreen('stats')}
          />
        );
      }

      return null;
    }

    // Render App
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Marketplace />);
  </script>
</body>
</html>
